<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡∏ô‡πâ‡∏≠‡∏¢ ‚Äî Dashboard ‡πÇ‡∏ó‡∏ô‡∏ü‡πâ‡∏≤-‡∏Ç‡∏≤‡∏ß (‡∏°‡∏µ Sidebar)</title>
<style>
  :root{
    --bg:#0b1220;            /* topbar dark blue */
    --bg-2:#0e1a33;          /* sidebar dark blue */
    --ink:#0f172a;           /* text */
    --muted:#64748b;         /* secondary text */
    --line:#e5e9f2;          /* borders */
    --accent:#2563eb;        /* blue accent */
    --good:#16a34a;          /* green */
    --warn:#eab308;          /* amber */
    --bad:#dc2626;           /* red */
    --paper:#ffffff;         /* surface */
    --card:#f8fafc;          /* card */
    --hover:#eff6ff;         /* light blue hover */
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0; overflow: hidden;} /* Prevent main page scroll */
  body{font:14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ink); background:#fff;}

  /* ===== Layout ===== */
  .topbar{position:sticky;top:0;z-index:50;background:var(--bg);color:#fff;border-bottom:1px solid rgba(255,255,255,.06)}
  .topbar .wrap{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
  .brand{font-size:16px;font-weight:600;margin-right:auto}
  .top-actions{display:flex;gap:8px;align-items:center}
  .top-actions input[type="search"]{border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.1); color:#fff; border-radius:999px; padding:8px 12px; min-width:220px}
  .top-actions input::placeholder{color:#e2e8f0}
  .icon-btn{border:0;background:rgba(255,255,255,.08); color:#fff; border-radius:10px; padding:8px 10px; cursor:pointer}
  .icon-btn:hover{background:rgba(255,255,255,.14)}

  .layout{display:grid; grid-template-columns:260px 1fr; height:calc(100vh - 52px)} /* Fix height */
  .sidebar{background:var(--bg-2); color:#e5e7eb; padding:14px 12px; border-right:1px solid rgba(255,255,255,.06); overflow-y: auto;} /* Add independent scroll */
  .sidebar .logo{display:flex; align-items:center; gap:8px; font-weight:700; letter-spacing:.2px; margin:4px 10px 14px}
  .sidebar .filter{margin:6px 10px 10px;font-size:12px;color:#e5e7eb;opacity:.95}
  .sidebar .filter input{margin-right:6px}
  .nav{display:flex; flex-direction:column; gap:4px; margin:8px}
  .nav a{display:flex; align-items:center; gap:10px; text-decoration:none; color:#e5e7eb; padding:10px 12px; border-radius:10px}
  .nav a:hover{background:rgba(255,255,255,.06)}
  .nav a.active{background:rgba(37,99,235,.22); color:#fff}
  
  .nav .count{margin-left:auto;font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#e2e8f0}
  .nav .count.lv0{background:rgba(22,163,74,.18);border-color:rgba(22,163,74,.35)}  /* 0 items (light green) */
  .nav .count.lv1{background:rgba(234,179,8,.20);border-color:rgba(234,179,8,.40)}  /* 1‚Äì2 (light yellow) */
  .nav .count.lv2{background:rgba(234,179,8,.32);border-color:rgba(234,179,8,.55)}  /* 3‚Äì5 (dark yellow) */
  .nav .count.lv3{background:rgba(220,38,38,.35);border-color:rgba(220,38,38,.60)}  /* >=6 (red) */

  .content{background:#fff; overflow-y: auto;}
  .container{max-width:1200px; margin:0 auto; padding:16px}

  footer{border-top:1px solid var(--line); padding:12px 16px; color:#64748b; background:#fff}

  /* ===== Generic Controls ===== */
  select,input[type=text],input[type=search],button{border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:14px;background:#fff;color:var(--ink)}
  button{cursor:pointer;background:var(--accent);color:#fff;border:0}
  button.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
  button.flat{background:#eef2ff;color:#1e40af}
  button.small{padding:6px 10px;font-size:12px;border-radius:8px}
  .pill{padding:4px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--line);font-size:12px}
  .panel{border:1px solid var(--line);border-radius:12px;background:var(--card);padding:10px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .status{display:flex;align-items:center;gap:8px}
  .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8;display:inline-block}
  .dot.ok{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  .spinner{width:12px;height:12px;border:2px solid #cbd5e1;border-top-color:var(--accent);border-radius:999px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== Cards & Table-ish list ===== */
  .card{border:1px solid var(--line);border-radius:12px;background:#fff}
  .card header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed var(--line);background:#fff;color:var(--ink)}
  .card header h2{margin:0;font-size:15px}
  .items{padding:8px}
  .item{display:grid;grid-template-columns:1fr 140px 92px;gap:6px;align-items:start;border:1px solid var(--line);border-radius:10px;padding:6px 8px;margin:6px 0}
  .item:hover{background:#f8fafc}
  .item .name{display:flex;align-items:center;gap:6px}
  .badge{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;border:1px solid var(--line);border-radius:999px;padding:2px 6px;background:#fff;color:#334155}
  .sev{width:8px;height:8px;border-radius:999px;display:inline-block; margin-top: 5px;}
  .sev.bad{background:var(--bad)} .sev.warn{background:var(--warn)} .sev.ok{background:var(--good)}
  .hint{color:#475569;font-size:12px}
  .copy-area{white-space:pre-wrap;border:1px dashed var(--line);border-radius:10px;padding:8px;background:#f8fafc;font:13px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;color:#334155}

  /* ===== Sticky actions ===== */
  .sticky{position:sticky;bottom:0;background:#fffffff2;backdrop-filter: blur(6px);border-top:1px solid var(--line);padding:8px;display:flex;gap:8px;justify-content:space-between;align-items:center}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%) translateY(20px);background:#0f172a;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:.25s;box-shadow:0 10px 24px rgba(15,23,42,.25);font-size:13px}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* ===== Responsive ===== */
  @media (max-width: 900px){
    .layout{grid-template-columns:1fr}
    .sidebar{position:fixed; inset:52px 0 auto 0; height:calc(100vh - 52px); transform:translateX(-100%); transition:.25s; z-index:40}
    body.show-sidebar .sidebar{transform:none}
  }
</style>
</head>
<body>
  <!-- ===== Topbar ===== -->
  <header class="topbar" role="banner">
    <div class="wrap">
      <button class="icon-btn" id="btnMenu" aria-label="Toggle sidebar">‚ò∞</button>
      <div class="brand">‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢ ‚Äî Dashboard</div>
      <div class="top-actions">
        <input type="search" id="globalSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö (‡∏ä‡∏∑‡πà‡∏≠/SKU/‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå)" />
        <span class="tag">Marketing</span>
      </div>
    </div>
  </header>

  <div class="layout">
    <!-- ===== Sidebar ===== -->
    <aside class="sidebar" role="navigation" aria-label="‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå">
      <div class="logo">üì¶ ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå</div>
      <div class="filter">
        <label><input type="checkbox" id="onlyUrgentSup"/> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á (>0)</label>
      </div>
      <nav class="nav" id="supList"></nav>
    </aside>

    <!-- ===== Main Content ===== -->
    <main class="content" role="main">
      <div class="container">

        <!-- Sync/status bar -->
        <div class="panel bar" id="syncBar">
          <div class="status" id="syncText"><span class="dot"></span> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          <div class="bar" style="margin-left:auto">
            <button id="btnResync" class="small">‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
          </div>
        </div>

        <!-- Controls -->
        <div class="bar" id="topControls" style="margin-top:10px">
          <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå
            <input id="itemSearch" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ SKU" />
          </label>
          <label class="bar"><input type="checkbox" id="onlyAlert" checked/> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á</label>
          <button id="prevSup" class="small ghost">‚óÄ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <button id="nextSup" class="small ghost">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂</button>
          <span class="pill" id="supMeta">-</span>
        </div>

        <!-- File upload / demo -->
        <div class="panel bar" id="uploadPanel" style="margin-top:12px">
          <strong>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î CSV</strong>
          <input id="file" type="file" accept=".csv" />
          <button id="loadDemo" class="small ghost">CSV ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
          <span class="hint">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: Supplier, SKU, Name, In stock, Low stock, Optimal stock</span>
        </div>

        <!-- Main view -->
        <div id="view" style="margin-top:10px"></div>

        <!-- Sticky actions -->
        <div class="sticky">
          <div class="bar">
            <button id="copyUrgentAll" class="small flat">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ‚Äú‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù</button>
            <span class="pill" id="stats">-</span>
          </div>
          <div class="bar">
            <button id="btnCopy" class="small">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å (‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ)</button>
            <button id="btnShare" class="small flat">‡πÅ‡∏ä‡∏£‡πå</button>
            <button id="btnDL" class="small ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î TXT</button>
          </div>
        </div>

      </div>
      <footer>¬© 2025 ‚Äî Minimal Blue Dashboard ‚Ä¢ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏∏‡∏°‡πÇ‡∏Ñ‡πâ‡∏á ‚Ä¢ ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sans-serif</footer>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
// ===== Config =====
const REMOTE_CSV_URL = 'https://raw.githubusercontent.com/kjakkrid1992-tech/loyverse-export-public/main/data/loyverse-price-latest.csv';
const LS = { CSV:'SNL_last_csv', SYNC_AT:'SNL_last_sync_at', COUNT:'SNL_last_count' };
const PREFS = { ONLY_URG_SUP:'SNL_only_urgent_sup' };

// ===== Utils =====
const $ = s => document.querySelector(s);
const el = (t,c,h)=>{const n=document.createElement(t); if(c) n.className=c; if(h!=null) n.innerHTML=h; return n;};
const num = v => {const n=parseFloat(String(v).replace(/,/g,'').trim()); return isNaN(n)?0:n};
const notEmpty = v => v!=null && String(v).trim()!=='';
const supplierName = v => notEmpty(v)? String(v).trim() : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå';
const fmtThai = ts => new Intl.DateTimeFormat('th-TH',{dateStyle:'medium', timeStyle:'short'}).format(ts);
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600); }

// Robust CSV parser
function parseCSV(text){
  const d = text.indexOf('\t')>-1 ? '\t' : (text.indexOf(';')>-1 ? ';' : ',');
  const rows = [];
  let i=0, field='', row=[], inQuotes=false; const s=text, dl=d;
  while(i<=s.length){
    const c = s[i];
    if(inQuotes){
      if(c==='\"'){
        if(s[i+1]==='\"'){ field+='\"'; i++; } else { inQuotes=false; }
      } else { field += c ?? ''; }
    } else {
      if(c==='\"') { inQuotes=true; }
      else if(c===dl) { row.push(field); field=''; }
      else if(c==='\n' || c==='\r' || i===s.length){
        row.push(field); field='';
        if(row.length>1 || (row.length===1 && row[0]!=='')) rows.push(row);
        row=[];
        if(c==='\r' && s[i+1]==='\n') i++;
      } else { field += c ?? ''; }
    }
    i++;
  }
  return rows;
}
// ==== Hotfix: replace parser at runtime to avoid stray newline tokens ====
const _parseCSV_fixed = function(text){
  const d = text.indexOf('\t')>-1 ? '\t' : (text.indexOf(';')>-1 ? ';' : ',');
  const rows = [];
  let i=0, field='', row=[], inQuotes=false; const s=text, dl=d;
  while(i<=s.length){
    const c = s[i];
    if(inQuotes){
      if(c==='\"'){
        if(s[i+1]==='\"'){ field+='\"'; i++; } else { inQuotes=false; }
      } else { field += c ?? ''; }
    } else {
      if(c==='\"') { inQuotes=true; }
      else if(c===dl) { row.push(field); field=''; }
      else if(c==='\n' || c==='\r' || i===s.length){
        row.push(field); field='';
        if(row.length>1 || (row.length===1 && row[0]!=='')) rows.push(row);
        row=[];
        if(c==='\r' && s[i+1]==='\n') i++;
      } else { field += c ?? ''; }
    }
    i++;
  }
  return rows;
};
try{ parseCSV = _parseCSV_fixed; }catch(e){}


function mapColumns(H){
  const headers=H.map(h=>String(h||'').trim());
  const find=(...keys)=>{ for(const k of keys){ const i=headers.findIndex(h=>h.toLowerCase()===k.toLowerCase()); if(i>-1) return i; } for(const k of keys){ const i=headers.findIndex(h=>h.toLowerCase().includes(k.toLowerCase())); if(i>-1) return i; } return -1; };
  return {
    supplier:find('Supplier','‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå'),
    sku:find('SKU','‡∏£‡∏´‡∏±‡∏™'),
    name:find('Name','‡∏ä‡∏∑‡πà‡∏≠'),
    instock:find('In stock [JERGUN CRAFT]','In stock','‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'),
    low:find('Low stock [JERGUN CRAFT]','Low stock','‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'),
    optimal:find('Optimal stock [JERGUN CRAFT]','Optimal stock','‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢')
  };
}

function computeItems(rows,col){
  const items=[]; for(let r=1;r<rows.length;r++){
    const row=rows[r]; if(!row||row.length===0) continue;
    const supplier=supplierName(row[col.supplier]);
    const sku=(row[col.sku]||'').toString().trim();
    const name=(row[col.name]||'').toString().trim();
    const instock=num(row[col.instock]);
    const low=num(row[col.low]);
    const optimal=num(row[col.optimal]);
    const reorder=Math.max(optimal-instock,0);
    items.push({supplier,sku,name,instock,low,optimal,reorder,editQty:''});
  } return items;
}

function groupBySupplier(items){ const m=new Map(); for(const it of items){ if(!m.has(it.supplier)) m.set(it.supplier,[]); m.get(it.supplier).push(it);} return m; }
const urgentCountSupplier = rows => rows.filter(it=> it.instock<=it.low && it.reorder>0).length;

// ===== State =====
const state={ items:[], bySup:new Map(), order:[], cur:0 };

function buildLine(it, forCopy){ const showSKU=true; const qty=(it.editQty && it.editQty.trim()!=='')? it.editQty.trim() : ('x '+it.reorder); const head=[showSKU && it.sku? it.sku:null, it.name].filter(Boolean).join(' '); return `${head} ${qty}${forCopy?'':''}`; }
function buildSupplierBlock(supplier, rows){ const lines=[String(supplier),'']; for(const it of rows) lines.push(buildLine(it,true)); return lines.join('\n'); }

// ===== Rendering =====
function refreshOrder(){
  state.bySup = groupBySupplier(state.items);
  const entries = Array.from(state.bySup.entries());
  entries.sort((a,b)=>{
    const ub = urgentCountSupplier(b[1]);
    const ua = urgentCountSupplier(a[1]);
    if(ub!==ua) return ub-ua; // Highest count first
    return a[0].localeCompare(b[0],'th');
  });
  state.order = entries.map(e=>e[0]);
  if(state.cur>=state.order.length) state.cur=0;
}

function renderTopControls(){
  $('#prevSup').onclick=()=>{ state.cur=(state.cur-1+state.order.length)%state.order.length; renderSupplier(); updateSidebarActive(); $('.content').scrollTop = 0; };
  $('#nextSup').onclick=()=>{ state.cur=(state.cur+1)%state.order.length; renderSupplier(); updateSidebarActive(); $('.content').scrollTop = 0; };
}

function renderSidebarSuppliers(){
  const list = document.getElementById('supList');
  if(!list) return;
  list.innerHTML='';
  const onlyUrg = localStorage.getItem(PREFS.ONLY_URG_SUP)==='1';

  // If onlyUrg is set and the current supplier has no urgent items, move to the first one that does.
  if(onlyUrg){
    const idx = state.order.findIndex(n=> urgentCountSupplier(state.bySup.get(n)||[])>0);
    if(idx>-1 && urgentCountSupplier(state.bySup.get(state.order[state.cur])||[])===0){ state.cur = idx; }
  }

  state.order.forEach((name, idx)=>{
    const rows = state.bySup.get(name)||[];
    const cnt = urgentCountSupplier(rows);
    if(onlyUrg && cnt===0) return; // Hide if count is 0 and filter is on
    const lvl = cnt>=6? 'lv3' : cnt>=3? 'lv2' : cnt>=1? 'lv1' : 'lv0';
    const a=document.createElement('a');
    a.href='#';
    a.dataset.name=name;
    a.className = (idx===state.cur? 'active' : '');
    a.innerHTML = `<span>${name}</span><span class="count ${lvl}">${cnt}</span>`;
    a.onclick=(ev)=>{ ev.preventDefault(); state.cur=idx; renderSupplier(); updateSidebarActive(); $('.content').scrollTop = 0; };
    list.appendChild(a);
  });
}
function updateSidebarActive(){
  document.querySelectorAll('#supList a').forEach((a,i)=> a.classList.toggle('active', i===state.cur));
}

function renderSupplier(){ const name=state.order[state.cur]; const rowsAll=state.bySup.get(name)||[]; const onlyAlert=$('#onlyAlert').checked; const q=($('#itemSearch').value||'').trim().toLowerCase();
  let rows=rowsAll.filter(it=> !onlyAlert || (it.instock<=it.low && it.reorder>0));
  if(q) rows=rows.filter(it=> it.name.toLowerCase().includes(q) || (it.sku||'').toLowerCase().includes(q));

  const view=$('#view'); view.innerHTML='';
  const card=el('div','card');
  const head=el('header','');
  const hleft=el('div','bar',`<h2>${name||'-'}</h2>`);
  const urgent=rowsAll.filter(it=> it.instock<=it.low && it.reorder>0).length;
  const zero=rowsAll.filter(it=> it.instock<=0).length;
  const meta=el('span','pill',`${rows.length} ‡∏à‡∏≤‡∏Å ${rowsAll.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ${urgent}${zero?` ‚Ä¢ ‡∏´‡∏°‡∏î ${zero}`:''}`);
  hleft.appendChild(meta);
  head.appendChild(hleft);
  card.appendChild(head);

  const list=el('div','items');
  rows.forEach(it=>{
    const row=el('div','item');
    const nameBox=el('div','name');
    const sev=el('i',`sev ${it.instock<=0?'bad':(it.instock<=it.low?'warn':'ok')}`,'');
    const sku=el('span','badge', it.sku||'-');
    
    const nameDetails = el('div');
    const nm=el('span','',it.name);
    const stockInfo = el('div', 'hint', `‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${it.instock} ‚Ä¢ ‡∏à‡∏∏‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ${it.low} ‚Ä¢ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${it.optimal}`);
    nameDetails.append(nm, stockInfo);
    
    nameBox.append(sev, sku, nameDetails);

    const qtyBox=el('div','');
    const input=document.createElement('input'); input.type='text'; input.placeholder=`x ${it.reorder}`; input.value=it.editQty; input.oninput=()=>{ it.editQty=input.value; refreshPreview(); };
    qtyBox.appendChild(input);

    const actions=el('div',''); const btnLine=el('button','small ghost','‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); btnLine.onclick=()=> copyText(buildLine(it,true)); actions.appendChild(btnLine);

    row.append(nameBox, qtyBox, actions); list.appendChild(row);
  });

  const preview=el('div','panel', '');
  const head2=el('div','hint','‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å');
  const pre=el('div','copy-area');
  function refreshPreview(){ pre.textContent = buildSupplierBlock(name, rows); }
  refreshPreview();
  preview.append(head2, pre);

  card.appendChild(list); card.appendChild(preview); view.appendChild(card);

  // footer buttons bind to this supplier
  $('#btnCopy').onclick=()=> copyText(buildSupplierBlock(name, rows));
  $('#btnShare').onclick=()=> shareText('‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: '+name, buildSupplierBlock(name, rows));
  $('#btnDL').onclick=()=> downloadSupplier(name, buildSupplierBlock(name, rows));

  $('#supMeta').textContent = `${state.cur+1}/${state.order.length}`;
  updateSidebarActive();
  updateStats();
}

function updateStats(){ const total=state.items.length; const sups=state.order.length; const urgentAll = state.items.filter(it=> it.instock<=it.low && it.reorder>0).length; $('#stats').textContent = `${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${sups} ‡∏ã‡∏±‡∏û‡∏û‡∏•‡∏≤‡∏¢‡πÄ‡∏≠‡∏≠‡∏£‡πå ‚Ä¢ ‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ${urgentAll}`; }

// ===== Copy/Share helpers =====
async function copyText(text){ try{ await navigator.clipboard.writeText(text); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì'); }catch(e){ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì'); }}
async function shareText(title, text){ if(navigator.share){ try{ await navigator.share({title, text}); }catch(e){ if(e?.name!=='AbortError') toast('‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } } else { await copyText(text); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ó‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß'); } }
function downloadSupplier(supplier, text){ const safe=String(supplier||'').replace(/[\/*?:"<>|]/g,'_'); const blob=new Blob([text],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå_${safe}.txt`; a.click(); URL.revokeObjectURL(a.href); }

// ===== Sync / Cache =====
function setSyncUI(stateStr, data={}){ const t=$('#syncText'); if(stateStr==='loading'){ t.innerHTML=`<span class="spinner"></span> <strong>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Å‡πå...</strong>`; } else if(stateStr==='ok'){ t.innerHTML=`<span class="dot ok"></span> ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ${data.count||0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${fmtThai(new Date(data.at))}`; } else if(stateStr==='cached'){ t.innerHTML=`<span class="dot warn"></span> ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‚Ä¢ ${fmtThai(new Date(data.at))} ‚Ä¢ ${data.count||0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; } else if(stateStr==='error'){ t.innerHTML=`<span class="dot bad"></span> ‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á`; } else { t.innerHTML=`<span class="dot"></span> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`; } }

function loadFromCache(){ const csv=localStorage.getItem(LS.CSV); const at=Number(localStorage.getItem(LS.SYNC_AT)||0); if(csv){ try{ const rows=parseCSV(csv); const col=mapColumns(rows[0]); state.items=computeItems(rows,col); refreshOrder(); renderSidebarSuppliers(); renderTopControls(); renderSupplier(); if(at) setSyncUI('cached',{at,count:state.items.length}); }catch(e){ console.error('cache parse',e);} }}

async function syncRemote({manual=false}={}){ const ctl=new AbortController(); const timer=setTimeout(()=>ctl.abort(),15000); setSyncUI('loading'); try{ const res=await fetch(REMOTE_CSV_URL,{cache:'no-store', signal:ctl.signal}); if(!res.ok) throw new Error('HTTP '+res.status); const text=await res.text(); const rows=parseCSV(text); if(!rows.length) throw new Error('EMPTY'); const col=mapColumns(rows[0]); const miss=Object.values(col).some(v=>v<0); if(miss) throw new Error('MISSING_COLS'); state.items=computeItems(rows,col); // save success only
    localStorage.setItem(LS.CSV,text); const at=Date.now(); localStorage.setItem(LS.SYNC_AT, String(at)); localStorage.setItem(LS.COUNT, String(state.items.length));
    refreshOrder(); renderSidebarSuppliers(); renderTopControls(); renderSupplier(); setSyncUI('ok',{at,count:state.items.length}); if(manual) toast('‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß ‚úì');
  }catch(err){ console.error('sync',err); setSyncUI('error'); toast('‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°'); if(!state.items.length) loadFromCache(); }
  finally{ clearTimeout(timer); }
}

// ===== Events =====
$('#itemSearch').addEventListener('input', ()=> renderSupplier());
$('#onlyAlert').addEventListener('change', ()=> renderSupplier());
$('#btnResync').addEventListener('click', ()=> syncRemote({manual:true}));
$('#copyUrgentAll').addEventListener('click', ()=>{
  const by = groupBySupplier(state.items.filter(it=> it.instock<=it.low && it.reorder>0));
  const blocks = [];
  for(const [sup, rows] of by.entries()) blocks.push(buildSupplierBlock(sup, rows));
  copyText(blocks.join('\n\n'));
});

$('#file').addEventListener('change', async ev=>{ const f=ev.target.files[0]; if(!f) return; const text=await f.text(); const rows=parseCSV(text); if(!rows.length) return alert('Cannot read CSV'); const col=mapColumns(rows[0]); const miss=Object.values(col).some(v=>v<0); if(miss) return alert('Missing columns'); state.items=computeItems(rows,col); localStorage.setItem(LS.CSV,text); const at=Date.now(); localStorage.setItem(LS.SYNC_AT, String(at)); localStorage.setItem(LS.COUNT, String(state.items.length)); refreshOrder(); renderSidebarSuppliers(); renderTopControls(); renderSupplier(); setSyncUI('cached',{at, count:state.items.length}); toast('Updated from file ‚úì'); });

$('#loadDemo').addEventListener('click', ()=>{ const headers=['Supplier','SKU','Name','In stock [JERGUN CRAFT]','Low stock [JERGUN CRAFT]','Optimal stock [JERGUN CRAFT]']; const rows=[ ['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏î‡∏£‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÑ‡∏ß‡πä‡∏ã‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î','10864','set ‡∏ã‡∏≠‡∏î‡πÅ‡∏à‡πâ‡∏á','4','6','6'], ['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏î‡∏£‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÑ‡∏ß‡πä‡∏ã‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î','10757','‡∏à‡πä‡∏ß‡∏î ‡πÇ‡∏Ñ‡∏•‡πà‡∏≤ 360 ml','0','6','12'], ['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏£‡∏∞‡∏¢‡∏≠‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°‡∏Ñ‡∏£‡∏≤‡∏ü‡∏ï‡πå ‡∏™‡∏õ‡∏¥‡∏£‡∏¥‡∏ï‡∏™‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î','10404','RAYONG CRAFT Spirits(‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏î‡∏≠‡∏Å‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß.‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î.‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÇ‡∏ï‡∏ô‡∏î)','3','5','5'], ['‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏','','‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏°‡∏µ SKU','0','1','4'] ]; const csv=[headers.join(','), ...rows.map(r=> r.map(v=>{const s=String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s;}).join(','))].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const f=new File([blob],'demo.csv',{type:'text/csv'}); const dt=new DataTransfer(); dt.items.add(f); const input=$('#file'); input.files=dt.files; input.dispatchEvent(new Event('change')); });

// Topbar controls
$('#btnMenu').addEventListener('click', ()=> document.body.classList.toggle('show-sidebar'));
$('#globalSearch').addEventListener('input', (e)=>{
  const q=(e.target.value||'').trim().toLowerCase();
  if(!q){ renderSupplier(); return; }
  const name=state.order[state.cur]; const rowsAll=state.bySup.get(name)||[];
  const onlyAlert=$('#onlyAlert').checked;
  let rows=rowsAll.filter(it=> !onlyAlert || (it.instock<=it.low && it.reorder>0));
  rows=rows.filter(it=> it.name.toLowerCase().includes(q) || (it.sku||'').toLowerCase().includes(q) || (it.supplier||'').toLowerCase().includes(q));
  const view=$('#view'); view.innerHTML='';
  const card=el('div','card');
  const head=el('header','');
  head.appendChild(el('div','',`<h2>Global Search: <span class="pill">${q}</span></h2>`));
  card.appendChild(head);
  const list=el('div','items');
  rows.forEach(it=>{
    const row=el('div','item');
    const nameBox=el('div','name');
    const sev=el('i',`sev ${it.instock<=0?'bad':(it.instock<=it.low?'warn':'ok')}`,'');
    const sku=el('span','badge', it.sku||'-');
    const nm=el('span','',`[${it.supplier}] ${it.name}`);
    nameBox.append(sev, sku, nm);
    const qtyBox=el('div','',`<span class="pill">Stock ${it.instock}</span>`);
    const actions=el('div',''); const btnLine=el('button','small ghost','Copy'); btnLine.onclick=()=> copyText(buildLine(it,true)); actions.appendChild(btnLine);
    row.append(nameBox, qtyBox, actions); list.appendChild(row);
  });
  card.appendChild(list); view.appendChild(card);
});

// ===== Boot =====
loadFromCache();
syncRemote();

const cbUrg = document.getElementById('onlyUrgentSup');if(cbUrg){
  cbUrg.checked = localStorage.getItem(PREFS.ONLY_URG_SUP)==='1';
  cbUrg.addEventListener('change', ()=>{
    localStorage.setItem(PREFS.ONLY_URG_SUP, cbUrg.checked?'1':'0');
    renderSidebarSuppliers();
  });
}
</script>
</body>
</html>
